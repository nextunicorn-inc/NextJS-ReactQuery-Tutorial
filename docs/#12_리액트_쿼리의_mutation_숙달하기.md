# #12: Mastering Mutations in React Query

ìš°ë¦¬ëŠ” ì´ë¯¸ React Queryê°€ ì œê³µí•˜ëŠ” ê¸°ëŠ¥ê³¼ ê°œë…ì— ëŒ€í•´ ë§Žì´ ë‹¤ë£¨ì—ˆìŠµë‹ˆë‹¤. ëŒ€ë¶€ë¶„ì€ *useQuery* hookì„ í†µí•´ ë°ì´í„°ë¥¼ ê²€ìƒ‰í•˜ëŠ” ê²ƒì´ì—ˆì£ . ì´ ìž‘ì—…ì—ëŠ” ê¼­ í•„ìš”í•œ ë‘ ë²ˆì§¸ í•„ìˆ˜ ìš”ì†Œê°€ ìžˆìŠµë‹ˆë‹¤. ë°”ë¡œ ë°ì´í„° ì—…ë°ì´íŠ¸ìž…ë‹ˆë‹¤.

ì´ use-caseì— ëŒ€í•´ React QueryëŠ” *useMutation* hookì„ ì œê³µí•©ë‹ˆë‹¤.

## **What are mutations?**

ì¼ë°˜ì ìœ¼ë¡œ, mutationì€ ë¶€ê°€ íš¨ê³¼(side effect)ë¥¼ í•¨ìˆ˜ìž…ë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´, ë°°ì—´ì— ê°’ì„ ë„£ëŠ” push ë©”ì„œë“œë¥¼ ì‚´íŽ´ë³´ì„¸ìš”. ê°’ì„ ë„£ì„ ë•Œ ë°°ì—´ì´ ë³€ê²½ë˜ëŠ” ë¶€ê°€ íš¨ê³¼ê°€ ìžˆìŠµë‹ˆë‹¤.

```tsx
const myArray = [1]
myArray.push(2)

console.log(myArray) // [1, 2]
```

*immutableí•œ ê²ƒì´ë¼ë©´* concatìœ¼ë¡œ ë°°ì—´ì— ê°’ì„ ì¶”ê°€í•  ìˆ˜ë„ ìžˆì§€ë§Œ, ì›ë³¸ ë°°ì—´ì„ ì§ì ‘ ì¡°ìž‘í•˜ëŠ” ëŒ€ì‹  ì‚¬ë³¸ ë°°ì—´ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.

```tsx
const myArray = [1]
const newArray = myArray.concat(2)

console.log(myArray) //  [1]
console.log(newArray) // [1, 2]
```

ì´ë¦„ì—ì„œ ì•Œ ìˆ˜ ìžˆë“¯ì´, *useMutation* ë˜í•œ ì¼ì¢…ì˜ ë¶€ìž‘ìš©ì„ ê°€ì§€ê³  ìžˆì£ . ìš°ë¦¬ëŠ” React Queryë¡œ [ì„œë²„ ìƒíƒœë¥¼ ê´€ë¦¬](https://tkdodo.eu/blog/react-query-as-a-state-manager)í•˜ëŠ” ìƒí™©ì— ìžˆê¸° ë•Œë¬¸ì— mutationsëŠ” ì„œë²„ì— ë¶€ê°€ íš¨ê³¼ë¥¼ ì¼ìœ¼í‚¤ëŠ” í•¨ìˆ˜ì— ëŒ€í•œ ë‚´ìš©ì„ ì •ì˜í•©ë‹ˆë‹¤. ë°ì´í„°ë² ì´ìŠ¤ì— todoë¥¼ ìž‘ì„±í•˜ëŠ” ê²ƒì€ mutationì´ ë  ìˆ˜ ìžˆìŠµë‹ˆë‹¤. ì‚¬ìš©ìž ë¡œê·¸ì¸ë„ ê³ ì „ì ì¸ mutationìœ¼ë¡œ, ì‚¬ìš©ìžë¥¼ ìœ„í•´ í† í°ì„ ìƒì„±í•˜ëŠ” ë¶€ê°€ íš¨ê³¼ë¥¼ ìˆ˜í–‰í•˜ê¸° ë•Œë¬¸ì´ì—ìš”.

ì–´ë–¤ ì¸¡ë©´ì—ì„œëŠ” *useQueryë¥¼* ìœ„í•´ *useMutation*ì„ ì‚¬ìš©í•©ë‹ˆë‹¤. ì´ ê²½ìš° ìœ„ì˜ ìƒí™©ê³¼ ê½¤ ë‹¤ë¥´ì£ .

## **Similarities to useQuery**

*useMutation*ì€ *useQuery*ê°€ ì¿¼ë¦¬ì— ëŒ€í•´ ìˆ˜í–‰í•˜ëŠ” ê²ƒì²˜ëŸ¼ mutationì˜ ìƒíƒœë¥¼ ì¶”ì í•©ë‹ˆë‹¤. *loading*, *error*
Â andÂ *status*Â fieldsë¥¼ ì œê³µí•˜ì—¬ ì‚¬ìš©ìžì—ê²Œ ë¬´ìŠ¨ ì¼ì´ ì¼ì–´ë‚˜ê³  ìžˆëŠ”ì§€ ì‰½ê²Œ í‘œì‹œí•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤.

ë˜í•œ *useQuery* ì½œë°±ê³¼ ë§ˆì°¬ê°€ì§€ë¡œ *onSuccess*,Â *onError* ë° *onSettled*ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤. ë¹„ìŠ·í•œ ì ì€ ì´ê²Œ ëì´ì—ìš”.

## **Differences to useQuery**

> *useQuery* is declarative,Â *useMutation*Â is imperative.
> 

ì¦‰, ì¿¼ë¦¬ëŠ” ëŒ€ë¶€ë¶„ ìžë™ìœ¼ë¡œ ì‹¤í–‰ë©ë‹ˆë‹¤. ì¢…ì†ì„±ì„ ì •ì˜í•˜ì§€ë§Œ React QueryëŠ” ì¦‰ì‹œ ì¿¼ë¦¬ ì‹¤í–‰ì„ ì²˜ë¦¬í•˜ê³  í•„ìš”í•˜ë‹¤ê³  íŒë‹¨ë  ê²½ìš° smart background updatesë„ ìˆ˜í–‰í•©ë‹ˆë‹¤. í™”ë©´ì— í‘œì‹œë˜ëŠ” ë‚´ìš©ì„ ë°±ì—”ë“œì˜ ì‹¤ì œ ë°ì´í„°ì™€ ë™ê¸°í™”í•˜ê¸° ë•Œë¬¸ì— ì¿¼ë¦¬ì— ë§¤ìš° ì í•©í•©ë‹ˆë‹¤.

mutationsì˜ ê²½ìš° ìž˜ ìž‘ë™í•˜ì§€ ì•Šì„ ê²ƒìž…ë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì°½ì— í¬ì»¤ìŠ¤ë¥¼ ë§žì¶œ ë•Œë§ˆë‹¤ ìƒˆë¡œìš´ todo í•­ëª©ì´ ìƒì„±ëœë‹¤ê³  ìƒìƒí•´ ë³´ì„¸ìš”ðŸ¤¨  ì¦‰, mutationë¥¼ ì¦‰ì‹œ ì‹¤í–‰í•˜ëŠ” ëŒ€ì‹ , React QueryëŠ” ì–¸ì œë“ ì§€ mutationë¥¼ ë§Œë“¤ê³  ì‹¶ì„ ë•Œ í˜¸ì¶œí•  ìˆ˜ ìžˆëŠ” í•¨ìˆ˜ë¥¼ ì œê³µí•©ë‹ˆë‹¤.

```tsx
function AddComment({ id }) {
  // this doesn't really do anything yet
  const addComment = useMutation((newComment) =>
    axios.post(`/posts/${id}/comments`, newComment)
  )

  return (
    <form
      onSubmit={(event) => {
        event.preventDefault()
        // âœ… mutation is invoked when the form is submitted
        addComment.mutate(new FormData(event.currentTarget).get('comment'))
      }}
    >
      <textarea name="comment" />
      <button type="submit">Comment</button>
    </form>
  )
}
```

ë˜ ë‹¤ë¥¸ ì°¨ì´ì ì€ mutationsê°€ *useQuery*ì²˜ëŸ¼ ìƒíƒœë¥¼ ê³µìœ í•˜ì§€ ì•ŠëŠ”ë‹¤ëŠ” ê²ƒìž…ë‹ˆë‹¤. ë‹¤ë¥¸ ì»´í¬ë„ŒíŠ¸ì—ì„œ ë™ì¼í•œ *useQuery*ë¥¼ **ì—¬ëŸ¬ ë²ˆ í˜¸ì¶œí•  ìˆ˜ ìžˆìœ¼ë©° ìºì‹œëœ ê²°ê³¼ë¥¼ ë™ì¼í•˜ê²Œ ë°˜í™˜í•˜ì§€ë§Œ mutationsì€ ë™ìž‘í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

## **Tying mutations to queries**

mutationsëŠ” ëŒ€ë¶€ë¶„ ì¿¼ë¦¬ì— ì§ì ‘ ì—°ê²°ë˜ì§€ ì•Šê²Œ ì„¤ê³„í•©ë‹ˆë‹¤. ê²Œì‹œë¬¼ì˜ â€œì¢‹ì•„ìš”â€ mutationì€ ê²Œì‹œë¬¼ì„ â€œfetchâ€í•˜ëŠ” ì¿¼ë¦¬ì™€ëŠ” ê´€ë ¨ì´ ì—†ì£ . ì´ë ‡ê²Œ í•˜ë ¤ë©´ React Queryì— ì—†ëŠ” ì¼ì¢…ì˜ ê¸°ë³¸ ìŠ¤í‚¤ë§ˆê°€ í•„ìš”í•©ë‹ˆë‹¤.

mutationì´ ì¿¼ë¦¬ì— ëŒ€í•œ ë³€ê²½ ì‚¬í•­ì„ ë°˜ì˜í•˜ê¸° ìœ„í•´ React QueryëŠ” ì£¼ë¡œ ë‹¤ìŒ ë‘ ê°€ì§€ ë°©ë²•ì„ ì œê³µí•©ë‹ˆë‹¤.

### **Invalidation**

ì´ê²ƒì€ í™”ë©´ì„ ìµœì‹  ìƒíƒœë¡œ ë§Œë“œëŠ” ê°€ìž¥ ê°„ë‹¨í•œ ê°œë…ì  ë°©ë²•ìž…ë‹ˆë‹¤. ì„œë²„ ìƒíƒœì—ì„œëŠ” íŠ¹ì • ì‹œì ì˜ ë°ì´í„° ìŠ¤ëƒ…ìƒ·ë§Œ í‘œì‹œí•©ë‹ˆë‹¤. React QueryëŠ” ì´ëŸ¬í•œ ì •ë³´ë¥¼ í•­ìƒ ìµœì‹  ìƒíƒœë¡œ ìœ ì§€í•˜ë ¤ê³  í•˜ì§€ë§Œ, ì˜ë„ì ìœ¼ë¡œ ì„œë²„ ìƒíƒœë¥¼ ë³€ê²½í•˜ë ¤ëŠ” ê²½ìš°, ì´ê²ƒì€ React Queryì—ê²Œ ìºì‹œëœ ì¼ë¶€ ë°ì´í„°ê°€ "ìž˜ëª»ëœ" ìƒíƒœìž„ì„ ì•Œë ¤ì£¼ëŠ” ì¢‹ì€ ì‹œì ì´ì£ . React Queryê°€ í˜„ìž¬ ì‚¬ìš© ì¤‘ì¸ ê²½ìš° í•´ë‹¹ ë°ì´í„°ë¥¼ ë‹¤ì‹œ ê°€ì ¸ì˜¤ê³ , ê°€ì ¸ì˜¤ê¸°ê°€ ì™„ë£Œë˜ë©´ í™”ë©´ì´ ìžë™ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤. ë¬´íš¨í™”í•  ì¿¼ë¦¬ë§Œ ë¼ì´ë¸ŒëŸ¬ë¦¬ì— ì•Œë ¤ì£¼ë©´ ë©ë‹ˆë‹¤.

```tsx
const useAddComment = (id) => {
  const queryClient = useQueryClient()

  return useMutation(
    (newComment) => axios.post(`/posts/${id}/comments`, newComment),
    {
      onSuccess: () => {
        // âœ… refetch the comments list for our blog post
        queryClient.invalidateQueries(['posts', id, 'comments'])
      },
    }
  )
}
```

ì¿¼ë¦¬ ë¬´íš¨í™”ëŠ” ê½¤ ë˜‘ë˜‘í•©ë‹ˆë‹¤. ëª¨ë“  [ì¿¼ë¦¬ í•„í„°](https://react-query.tanstack.com/guides/filters#query-filters)ì™€ ë§ˆì°¬ê°€ì§€ë¡œ ì¿¼ë¦¬ í‚¤ì˜ í¼ì§€ ë§¤ì¹­ì„ ì‚¬ìš©í•©ë‹ˆë‹¤. ë”°ë¼ì„œ comments listsì— í‚¤ê°€ ì—¬ëŸ¬ ê°œ ìžˆìœ¼ë©´ ëª¨ë‘ ë¬´íš¨í™”ë˜ê³  í˜„ìž¬ í™œì„± ìƒíƒœì¸ í•­ëª©ë§Œ ë‹¤ì‹œ ê°€ì ¸ì˜µë‹ˆë‹¤. ë‚˜ë¨¸ì§€ëŠ” ì˜¤ëž˜ëœ ê²ƒìœ¼ë¡œ í‘œì‹œë˜ë©°, ë‹¤ìŒì— ì‚¬ìš©í•  ë•Œ re-fetchë©ë‹ˆë‹¤.

ì˜ˆë¥¼ ë“¤ì–´, commentsì„ ì •ë ¬í•  ìˆ˜ ìžˆëŠ” ì˜µì…˜ì´ ìžˆ ìƒˆ commentsê°€ ì¶”ê°€ë˜ì—ˆì„ ë•Œ ìºì‹œì— commentsê°€ í¬í•¨ëœ ë‘ ê°œì˜ ì¿¼ë¦¬ê°€ ìžˆë‹¤ê³  ê°€ì •í•©ë‹ˆë‹¤.

```tsx
['posts', 5, 'comments', { sortBy: ['date', 'asc'] }
['posts', 5, 'comments', { sortBy: ['author', 'desc'] }
```

ì´ ì¤‘ í•˜ë‚˜ë§Œ í™”ë©´ì— í‘œì‹œë˜ë¯€ë¡œ ë¬´íš¨í™”ëœ ì¿¼ë¦¬ëŠ” í•´ë‹¹ ì¿¼ë¦¬ë¥¼ ë‹¤ì‹œ ê²€ìƒ‰í•˜ê³  ë‹¤ë¥¸ í•˜ë‚˜ëŠ” ì˜¤ëž˜ëœ ê²ƒìœ¼ë¡œ í‘œì‹œí•©ë‹ˆë‹¤.

## **Direct updates**

íŠ¹ížˆ mutationê°€ ì´ë¯¸ ì•Œì•„ì•¼ í•  ëª¨ë“  ì •ë³´ë¥¼ ë°˜í™˜í•˜ëŠ” ê²½ìš° ë°ì´í„°ë¥¼ ë‹¤ì‹œ ê²€ìƒ‰í•˜ì§€ ì•Šìœ¼ë ¤ëŠ” ê²½ìš°ê°€ ìžˆìŠµë‹ˆë‹¤. ê²Œì‹œê¸€ì˜ ì œëª©ì„ ì—…ë°ì´íŠ¸í•˜ëŠ” mutationì´ ìžˆê³  ë°±ì—”ë“œê°€ ì „ì²´ ê²Œì‹œê¸€ì„ ì‘ë‹µí•˜ëŠ” ê²½ìš° *setQueryData*ë¥¼ í†µí•´ ì§ì ‘ ì¿¼ë¦¬ ìºì‹œë¥¼ ì—…ë°ì´íŠ¸í•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤.

```tsx
const useUpdateTitle = (id) => {
  const queryClient = useQueryClient()

  return useMutation(
    (newTitle) => axios.patch(`/posts/${id}`, { title: newTitle }),
    {
      // ðŸ’¡ response of the mutation is passed to onSuccess
      onSuccess: (newPost) => {
        // âœ… update detail view directly
        queryClient.setQueryData(['posts', id], newPost)
      },
    }
  )
}
```

*setQueryData*ë¥¼ í†µí•´ ì§ì ‘ ìºì‹œì— ë°ì´í„°ë¥¼ ë„£ìœ¼ë©´ ì´ ë°ì´í„°ê°€ ë°±ì—”ë“œì—ì„œ ë°˜í™˜ëœ ê²ƒì²˜ëŸ¼ ë™ìž‘í•˜ë©°, ì´ëŠ” í•´ë‹¹ ì¿¼ë¦¬ë¥¼ ì‚¬ìš©í•˜ëŠ” ëª¨ë“  ì»´í¬ë„ŒíŠ¸ê°€ ë‹¤ì‹œ ë Œë”ë§ëœë‹¤ëŠ” ê²ƒì„ ì˜ë¯¸í•©ë‹ˆë‹¤.

ì§ì ‘ ì—…ë°ì´íŠ¸ì™€ [#8: Effective React Query Key](https://tkdodo.eu/blog/effective-react-query-keys#structure)ì˜ ë‘ ê°€ì§€ ì ‘ê·¼ ë°©ì‹ì˜ ì¡°í•©ì— ëŒ€í•œ ëª‡ ê°€ì§€ ì˜ˆë¥¼ ë³´ì—¬ë“œë¦¬ê² ìŠµë‹ˆë‹¤.

---

ì €ëŠ” ê°œì¸ì ìœ¼ë¡œ ëŒ€ë¶€ë¶„ ë¬´íš¨ê°€ ì„ í˜¸ë˜ì–´ì•¼ í•œë‹¤ê³  ìƒê°í•©ë‹ˆë‹¤. ë¬¼ë¡  ìƒí™©ì— ë”°ë¼ ë‹¤ë¥´ì§€ë§Œ ì§ì ‘ ì—…ë°ì´íŠ¸ê°€ ì•ˆì •ì ìœ¼ë¡œ ìž‘ë™í•˜ë ¤ë©´ í”„ë¡ íŠ¸ì—”ë“œì— ë” ë§Žì€ ì½”ë“œê°€ í•„ìš”í•˜ë©° ë°±ì—”ë“œì˜ ì¤‘ë³µ ë¡œì§ì´ ì–´ëŠ ì •ë„ í•„ìš”í•©ë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´, ì§ì ‘ ì—…ë°ì´íŠ¸ ì‹œ ì •ë ¬ëœ ëª©ë¡ì€ ë‚´ë¶€ í•­ëª©ì˜ ìœ„ì¹˜ê°€ ë³€ê²½ë  ìˆ˜ ìžˆê¸° ë•Œë¬¸ì— ë§¤ìš° ì–´ë µìŠµë‹ˆë‹¤. ì „ì²´ ëª©ë¡ì„ ë¬´íš¨í™”í•˜ëŠ” ê²ƒì´ "ì•ˆì „í•œ" ì ‘ê·¼ë²•ì´ì—ìš”.

## **Optimistic updates**

ë‚™ê´€ì ì¸ ì—…ë°ì´íŠ¸ëŠ” React Query mutationsë¥¼ ì‚¬ìš©í•˜ê¸° ìœ„í•œ ì „ëžµ ì¤‘ í•˜ë‚˜ìž…ë‹ˆë‹¤. *useQuery* ìºì‹œëŠ” ì¿¼ë¦¬ ê°„ ì „í™˜ ì‹œ, íŠ¹ížˆ [prefetching](https://react-query.tanstack.com/guides/prefetching)ê³¼ ê²°í•©í•  ë•Œ ë°ì´í„°ë¥¼ ì¦‰ì‹œ ì œê³µí•©ë‹ˆë‹¤. ì´ê²ƒ ë•Œë¬¸ì— ì „ì²´ì ì¸ UIê°€ ë§¤ìš° ë¹ ë¥´ê²Œ ëŠê»´ì§‘ë‹ˆë‹¤. ê·¸ë ‡ë‹¤ë©´ mutationsë„ ê°™ì€ ì´ì ì„ ì–»ì„ ìˆ˜ ìžˆì§€ ì•Šì„ê¹Œìš”?

ëŒ€ë¶€ë¶„ì˜ ê²½ìš° ì—…ë°ì´íŠ¸ê°€ ì§„í–‰ë  ê²ƒì´ë¼ê³  í™•ì‹ í•©ë‹ˆë‹¤. ì‚¬ìš©ìžê°€ UIì— ê²°ê³¼ë¥¼ í‘œì‹œí•˜ê¸° ìœ„í•´ ë°±ì—”ë“œì˜ ìŠ¹ì¸ì„ ë°›ì„ ë•Œê¹Œì§€ ëª‡ ì´ˆ ë™ì•ˆ ê¸°ë‹¤ë ¤ì•¼ í•˜ëŠ” ì´ìœ ê°€ ë¬´ì—‡ì¼ê¹Œìš”? ë‚™ê´€ì ì¸ ì—…ë°ì´íŠ¸ì˜ ì•„ì´ë””ì–´ëŠ” ì„œë²„ì— ì „ì†¡í•˜ê¸°ë„ ì „ì— mutationsì˜ ì„±ê³µì„ ê°€ìž¥í•˜ëŠ” ê²ƒìž…ë‹ˆë‹¤. ì¼ë‹¨ ì„±ê³µì ì¸ ì‘ë‹µì„ ë°›ìœ¼ë©´, ì‹¤ì œ ë°ì´í„°ë¥¼ ë³´ê¸° ìœ„í•´ ë‹¤ì‹œ ë¬´íš¨í™”ë§Œ í•˜ë©´ ë©ë‹ˆë‹¤. ìš”ì²­ì´ ì‹¤íŒ¨í•˜ë©´ UIë¥¼ ë³€í™˜ ì „ ìƒíƒœë¡œ ë¡¤ë°±í•˜ëŠ”ê±°ì£ .

ì‹¤ì œë¡œ, ì¦‰ê°ì ì¸ ì‚¬ìš©ìž í”¼ë“œë°±ì´ í•„ìš”í•œ ì†Œê·œëª¨ì˜ mutationsì— ë§¤ìš° íš¨ê³¼ì ìž…ë‹ˆë‹¤. ìš”ì²­ì„ ìˆ˜í–‰í•˜ëŠ” í† ê¸€ ë²„íŠ¼ë³´ë‹¤ ë” ë‚˜ìœ ê²ƒì´ ì—†ëŠ” ì´ìœ ê°€, ìš”ì²­ì´ ì™„ë£Œë  ë•Œê¹Œì§€ ì „í˜€ ë°˜ì‘í•˜ì§€ ì•Šìœ¼ë‹ˆê¹Œìš”. ì‚¬ìš©ìžë“¤ì€ ê·¸ ë²„íŠ¼ì„ ë‘ ë²ˆ ë˜ëŠ” ì„¸ ë²ˆ í´ë¦­í•  ê²ƒì´ê³ , ëª¨ë“  ê³³ì—ì„œ "laggy"ë¥¼ ëŠë¼ê² ì£ .

## **Example**

ì €ëŠ” ì¶”ê°€ì ì¸ ì˜ˆë¥¼ ë³´ì—¬ì£¼ì§€ ì•Šê¸°ë¡œ í–ˆìŠµë‹ˆë‹¤. [ê³µì‹ ë¬¸ì„œ](https://react-query.tanstack.com/guides/optimistic-updates)ëŠ” ì´ ì£¼ì œë¥¼ ìž˜ ë‹¤ë£¨ê³  ìžˆìœ¼ë©°, [JavaScript](https://react-query.tanstack.com/examples/optimistic-updates)ì™€ [TypeScript](https://react-query.tanstack.com/examples/optimistic-updates-typescript)ì˜ ì˜ˆì œë„ ìžˆìŠµë‹ˆë‹¤.

ì „ ë‚™ê´€ì ì¸ ì—…ë°ì´íŠ¸ê°€ ì¡°ê¸ˆ ê³¼ë„í•˜ê²Œ ì‚¬ìš©ëœë‹¤ê³  ìƒê°í•©ë‹ˆë‹¤. ëª¨ë“  mutationì´ ë‚™ê´€ì ìœ¼ë¡œ ì´ë£¨ì–´ì§ˆ í•„ìš”ëŠ” ì—†ì–´ìš”. ë¡¤ë°±ì— ëŒ€í•œ UXê°€ ì¢‹ì§€ ì•Šê¸° ë•Œë¬¸ì— ì‹¤íŒ¨í•˜ëŠ” ì¼ì´ ê±°ì˜ ì—†ë„ë¡ í•´ì•¼ í•©ë‹ˆë‹¤. submit ì‹œ ë‹«ížˆëŠ” Dialogì˜ Formì´ë‚˜ ì—…ë°ì´íŠ¸ í›„ detail viewì—ì„œ list viewë¡œ redirectí•˜ëŠ” ê±¸ ìƒìƒí•´ ë³´ì„¸ìš”. ì¼ì° í–‰í•´ì§€ê²Œ ë˜ë©´ ë¡¤ë°±í•˜ê¸° ì–´ë µì§€ ì•Šì„ê¹Œìš”?

ë˜í•œ ìœ„ì˜ í† ê¸€ ë²„íŠ¼ ì˜ˆì‹œì™€ ê°™ì´ ì¦‰ê°ì ì¸ í”¼ë“œë°±ì´ ì •ë§ë¡œ í•„ìš”í•œì§€ í™•ì¸í•´ì£¼ì„¸ìš”. íŠ¹ížˆ ë‚™ê´€ì ì¸ ì—…ë°ì´íŠ¸ë¥¼ ìž‘ë™ì‹œí‚¤ëŠ” ë° í•„ìš”í•œ ì½”ë“œëŠ” "í‘œì¤€" ëŒì—°ë³€ì´ì™€ ë¹„êµí•´ë³´ë©´ ê²°ì½” ì‚¬ì†Œí•˜ì§€ ì•Šê±°ë“ ìš”. ê²°ê³¼ë¥¼ ì¡°ìž‘í•  ë•ŒëŠ” ë°±ì—”ë“œê°€ ìˆ˜í–‰í•˜ëŠ” ìž‘ì—…ì„ ëª¨ë°©í•´ì•¼ í•©ë‹ˆë‹¤. ì´ëŠ” booleanì„ ë¶€ì •í•˜ì—¬ ë°˜í™˜í•˜ë‚˜ ê°’ì„ ë°°ì—´ì— ì¶”ê°€í•˜ëŠ” ê²ƒë§Œí¼ ê°„ë‹¨í•  ìˆ˜ ìžˆì§€ë§Œ ë§¤ìš° ë¹ ë¥´ê²Œ ë³µìž¡í•´ì§ˆ ìˆ˜ë„ ìžˆìŠµë‹ˆë‹¤.

- ì¶”ê°€í•˜ëŠ” ìž‘ì—… í•­ëª©ì— IDê°€ í•„ìš”í•œ ê²½ìš°, ì–´ë””ì—ì„œ ì–»ì–´ì•¼ í• ê¹Œìš”?
- í˜„ìž¬ ë³´ê³  ìžˆëŠ” ëª©ë¡ì´ ì •ë ¬ëœ ê²½ìš° ì˜¬ë°”ë¥¸ ìœ„ì¹˜ì— ìƒˆ í•­ëª©ì„ ë„£ìœ¼ë ¤ë©´ ì–´ë–»ê²Œ í•´ì•¼ í• ê¹Œìš”?
- ê·¸ ì‚¬ì´ì— ë‹¤ë¥¸ ì‚¬ìš©ìžê°€ ë‹¤ë¥¸ í•­ëª©ì„ ì¶”ê°€í–ˆë‹¤ë©´ ì–´ë–»ê²Œ í•´ì•¼ í•˜ë‚˜ìš”? ë‚™ê´€ì ìœ¼ë¡œ ì¶”ê°€í•œ ì—”íŠ¸ë¦¬ ìœ„ì¹˜ê°€ re-fetch í›„ ì „í™˜ë©ë‹ˆê¹Œ?

ì´ëŸ¬í•œ ëª¨ë“  edge ì¼€ì´ìŠ¤ëŠ” UXë¥¼ ì‹¤ì œë¡œ ë” ë‚˜ì˜ê²Œ ë§Œë“¤ ìˆ˜ ìžˆëŠ”ë°, ì–´ë–¤ ìƒí™©ì—ì„œëŠ” mutationì´ ìˆ˜í–‰ë˜ëŠ” ë™ì•ˆ ë²„íŠ¼ì„ ë¹„í™œì„±í™”ì‹œí‚¤ê³  ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ì„ ë³´ì—¬ì£¼ê¸°ëŠ” ê²ƒìœ¼ë¡œ ì¶©ë¶„í•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤. í•­ìƒ ê·¸ë ‡ë“¯ì´, ì˜¬ë°”ë¥¸ ìž‘ì—…ì— ì í•©í•œ ë„êµ¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.

## **Common Gotchas**

ë§ˆì§€ë§‰ìœ¼ë¡œ, ì²˜ìŒì—ëŠ” í™•ì‹¤í•˜ì§€ ì•Šì„ ìˆ˜ ìžˆëŠ” mutationsë¥¼ ë‹¤ë£° ë•Œ ì¢‹ì€ ëª‡ ê°€ì§€ ì‚¬í•­ì— ëŒ€í•´ ìžì„¸ížˆ ì•Œì•„ë³¼ê²Œìš”.

### **awaited Promises**

mutation ì½œë°±ì—ì„œ ë°˜í™˜ëœ PromiseëŠ” React Queryì— ì˜í•´ ëŒ€ê¸°(awaited)ë˜ë©°, ì‹¤ì œë¡œ *invalidateQueries*ëŠ” Promiseë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤. ê´€ë ¨ ì¿¼ë¦¬ê°€ ì—…ë°ì´íŠ¸ë˜ëŠ” ë™ì•ˆ ë³€í™˜ì„ *loading* ìƒíƒœë¡œ ìœ ì§€í•˜ë ¤ë©´ ì½œë°±ì—ì„œ *invalidateQueries* ê²°ê³¼ë¥¼ ë°˜í™˜í•´ì•¼ í•©ë‹ˆë‹¤.

```tsx
{
  // ðŸŽ‰ will wait for query invalidation to finish
  onSuccess: () => {
    return queryClient.invalidateQueries(['posts', id, 'comments'])
  }
}
{
  // ðŸš€ fire and forget - will not wait
  onSuccess: () => {
    queryClient.invalidateQueries(['posts', id, 'comments'])
  }
}
```

### **Mutate or MutateAsync**

*useMutation*ì€ *mutate* ë° *mutateAsync* ë‘ ê°€ì§€ í•¨ìˆ˜ë¥¼ ì œê³µí•©ë‹ˆë‹¤. ì°¨ì´ì ì€ ë¬´ì—‡ì´ê³ , ì–¸ì œ ì–´ë–¤ ê±¸ ì‚¬ìš©í•´ì•¼ í• ê¹Œìš”?

*mutateëŠ”* ì•„ë¬´ê²ƒë„ ë°˜í™˜í•˜ì§€ ì•ŠëŠ” ë°˜ë©´ *mutateAsync*ëŠ” ëŒì—°ë³€ì´ì˜ ê²°ê³¼ë¥¼ í¬í•¨í•˜ëŠ” Promiseë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤. mutation responseì— ëŒ€í•œ ì ‘ê·¼ì´ í•„ìš”í•  ë•Œ *mutateAsync*ë¥¼ ì‚¬ìš©í•˜ê³ ìž í•  ìˆ˜ë„ ìžˆì§€ë§Œ, ì €ëŠ” ê±°ì˜ í•­ìƒ *mutate*ë¥¼ ì‚¬ìš©í•´ì•¼ í•œë‹¤ê³  ì£¼ìž¥í•©ë‹ˆë‹¤.

*mutate*ëŠ” ì½œë°±ì„ í†µí•´ ë°ì´í„°ë‚˜ ì˜¤ë¥˜ì— ì•¡ì„¸ìŠ¤í•  ìˆ˜ ìžˆìœ¼ë©° ì˜¤ë¥˜ ì²˜ë¦¬ì— ëŒ€í•´ ê±±ì •í•  í•„ìš”ê°€ ì—†ìŠµë‹ˆë‹¤. *mutateAsyncëŠ”* Promiseë¥¼ ì œì–´í•  ìˆ˜ ìžˆìœ¼ë¯€ë¡œ ì˜¤ë¥˜ë¥¼ ì§ì ‘ ì²˜ë¦¬í•´ì•¼ í•©ë‹ˆë‹¤. ê·¸ë ‡ì§€ ì•Šìœ¼ë©´ [unhandled promise rejection](https://stackoverflow.com/questions/40500490/what-is-an-unhandled-promise-rejection)ì´ ë°œìƒí•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤.

```tsx
const onSubmit = () => {
  // âœ… accessing the response via onSuccess
  myMutation.mutate(someData, {
    onSuccess: (data) => history.push(data.url),
  })
}

const onSubmit = async () => {
  // ðŸš¨ works, but is missing error handling
  const data = await myMutation.mutateAsync(someData)
  history.push(data.url)
}

const onSubmit = async () => {
  // ðŸ˜• this is okay, but look at the verbosity
  try {
    const data = await myMutation.mutateAsync(someData)
    history.push(data.url)
  } catch (error) {
    // do nothing
  }
}
```

React QueryëŠ” ë‚´ë¶€ì ìœ¼ë¡œ ì˜¤ë¥˜ë¥¼ ìºì¹˜í•˜ê±°ë‚˜ ë¬´ì‹œí•˜ë¯€ë¡œ *mutate*ë¥¼ ì‚¬ìš©í•  ë•Œ ì˜¤ë¥˜ë¥¼ ì²˜ë¦¬í•  í•„ìš”ê°€ ì—†ìŠµë‹ˆë‹¤. ë¬¸ìž ê·¸ëŒ€ë¡œ *mutateAsync().catch(noop)*ê°€ êµ¬í˜„ë˜ì–´ ìžˆìŠµë‹ˆë‹¤ ðŸ˜Ž

*mutateAsync*ê°€ ë” ë›°ì–´ë‚  ìœ ì¼í•œ ìƒí™©ì€ ì—¬ëŸ¬ë¶„ì´ ì •ë§ë¡œ Promiseê°€ í•„ìš”í•˜ì—¬ Promiseë¥¼ ì§€ì¼œì•¼ í•  ë•Œìž…ë‹ˆë‹¤. ì´ê²ƒì€ ì—¬ëŸ¬ mutationsë¥¼ ë™ì‹œì— ì‹œìž‘í•˜ê³  ëª¨ë“  mutationsì´ ëë‚˜ê¸°ë¥¼ ê¸°ë‹¤ë¦¬ê±°ë‚˜, ì½œë°± ì§€ì˜¥ì— ë¹ ì§ˆ ìˆ˜ ìžˆëŠ” ì˜ì¡´ì  mutationsì´ ìžˆëŠ” ê²½ìš°ì— í•„ìš”í•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤.

### **Mutations only take one argument for variables**

ë³€í™˜í•˜ëŠ” ë§ˆì§€ë§‰ ì¸ìˆ˜ê°€ ì˜µì…˜ ê°ì²´ì´ë¯€ë¡œ *useMutation*ì€ í˜„ìž¬ ë³€ìˆ˜ì— ëŒ€í•´ í•˜ë‚˜ì˜ ì¸ìˆ˜ë§Œ ì‚¬ìš©í•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤. í™•ì‹¤ížˆ ì´ê±´ ì œí•œì ì´ì§€ë§Œ, ê°ì²´ë¥¼ ì‚¬ìš©í•˜ì—¬ ì‰½ê²Œ í•´ê²°í•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤.

```tsx
// ðŸš¨ this is invalid syntax and will NOT work
const mutation = useMutation((title, body) => updateTodo(title, body))
mutation.mutate('hello', 'world')

// âœ… use an object for multiple variables
const mutation = useMutation(({ title, body }) => updateTodo(title, body))
mutation.mutate({ title: 'hello', body: 'world' })
```

í˜„ìž¬ í•„ìš”í•œ ì´ìœ ì— ëŒ€í•´ ìžì„¸ížˆ ì•Œì•„ë³´ë ¤ë©´ [ì´ í† ë¡ ](https://github.com/tannerlinsley/react-query/discussions/1226)ì„ ì°¸ì¡°í•˜ì‹­ì‹œì˜¤.

### **Some callbacks might not fire**

*useMutation*ì— ëŒ€í•œ ì½œë°±ë¿ë§Œ ì•„ë‹ˆë¼ *mutate*ì— ëŒ€í•œ ì½œë°±ì„ ê°€ì§ˆ ìˆ˜ ìžˆìŠµë‹ˆë‹¤. *mutate*ì˜ ì½œë°± ì „ì— u*seMutation*Â ì´ í˜¸ì¶œë˜ëŠ” ê²ƒì„ ì•Œì•„ì•¼ í•©ë‹ˆë‹¤. ë˜í•œ ë³€í™˜ì´ ì™„ë£Œë˜ê¸° ì „ì— ì»´í¬ë„ŒíŠ¸ê°€ ë§ˆìš´íŠ¸ í•´ì œëœ ê²½ìš° *mutate* ì½œë°±ì´ ì „í˜€ ì‹¤í–‰ë˜ì§€ ì•Šì„ ìˆ˜ ìžˆìŠµë‹ˆë‹¤.

ê·¸ë ‡ê¸° ë•Œë¬¸ì— ì½œë°±ì—ì„œ ë¬¸ì œë¥¼ ë¶„ë¦¬í•˜ëŠ” ê²ƒì´ ì¢‹ë‹¤ê³  ìƒê°í•©ë‹ˆë‹¤.

- ì ˆëŒ€ì ìœ¼ë¡œ í•„ìš”í•œ ìž‘ì—… ë° ë¡œì§ ê´€ë ¨ ìž‘ì—…(ì¿¼ë¦¬ ë¬´íš¨í™” ë“±)ì„ *useMutation* ì½œë°±ì—ì„œ ìˆ˜í–‰í•©ë‹ˆë‹¤.
- ë¦¬ë””ë ‰ì…˜ ë˜ëŠ” í† ìŠ¤íŠ¸ ì•Œë¦¼ì„ ì½œë°±ìœ¼ë¡œ í‘œì‹œí•˜ëŠ” ê²ƒê³¼ ê°™ì€ UI ê´€ë ¨ ìž‘ì—…ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤. ì‚¬ìš©ìžê°€ ë³€í™˜ì´ ì™„ë£Œë˜ê¸° ì „ì— í˜„ìž¬ í™”ë©´ì—ì„œ ë©€ë¦¬ íƒìƒ‰í•œ ê²½ìš°, ì´ëŸ¬í•œ í™”ë©´ì€ ì˜ë„ì ìœ¼ë¡œ ìž‘ë™í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

Custom hookì—ì„œ *useMutation*ì´ ë‚˜ì˜¨ ê²½ìš° UI ê´€ë ¨ ìž‘ì—…ì´ UIì— ìžˆëŠ” ë™ì•ˆ ì¿¼ë¦¬ ê´€ë ¨ ë¡œì§ì„ Custom hookì—ì„œ ìœ ì§€í•  ìˆ˜ ìžˆê¸° ë•Œë¬¸ì— ì´ëŸ¬í•œ ë¶„ë¦¬ëŠ” ê½¤ ê¹”ë”í•©ë‹ˆë‹¤. ë˜í•œ UIì™€ ìƒí˜¸ ìž‘ìš©í•˜ëŠ” ë°©ë²•ì€ ê²½ìš°ì— ë”°ë¼ ë‹¤ë¥¼ ìˆ˜ ìžˆì–´ë„ ë¬´íš¨í™” ë…¼ë¦¬ëŠ” í•­ìƒ ë™ì¼í•˜ê¸° ë•Œë¬¸ì— Custom hookì˜ ìž¬ì‚¬ìš©ì„±ì´ ë†’ìŠµë‹ˆë‹¤.

```tsx
const useUpdateTodo = () =>
  useMutation(updateTodo, {
    // âœ… always invalidate the todo list
    onSuccess: () => {
      queryClient.invalidateQueries(['todos', 'list'])
    },
  })

// in the component

const updateTodo = useUpdateTodo()
updateTodo.mutate(
  { title: 'newTitle' },
  // âœ… only redirect if we're still on the detail page
  // when the mutation finishes
  { onSuccess: () => history.push('/todos') }
)
```